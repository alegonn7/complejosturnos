// Sistema de Gestión de Turnos para Canchas
generator client {
  provider = "prisma-client-js"
  
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")

}

// USUARIOS
enum RolUsuario {
  SUPERADMIN
  DUENO
  EMPLEADO
  CLIENTE
}

model Usuario {
  id        String     @id @default(cuid())
  email     String?    @unique
  telefono  String     @unique
  dni       String?    @unique
  nombre    String
  apellido  String
  rol       RolUsuario @default(CLIENTE)
  password  String?
  
  complejoId String?
  complejo   Complejo? @relation(fields: [complejoId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  complejosPropios Complejo[] @relation("ComplejosPropietario")
  turnos           Turno[]
  turnosFijos      TurnoFijo[]
  
  @@index([telefono])
  @@index([dni])
}

// COMPLEJOS
model Complejo {
  id          String   @id @default(cuid())
  slug        String?   @unique
  nombre      String
  direccion   String
  telefono    String
  email       String?
  
  cbu         String?
  alias       String?
  titular     String?
  
  mercadoPagoAccessToken  String?
  mercadoPagoPublicKey    String?
  mercadoPagoQR           String? 

  requiereSeña       Boolean @default(true)
  porcentajeSeña     Int     @default(50)
  minutosExpiracion  Int     @default(30)
  permiteTurnosFijos Boolean @default(true)
  
  numeroWhatsapp String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  propietarioId String?
  propietario   Usuario?  @relation("ComplejosPropietario", fields: [propietarioId], references: [id])

  configuracionTema ConfiguracionTema?  
  empleados  Usuario[]
  canchas    Cancha[]
  deportes   Deporte[]
  turnos     Turno[]
}

// DEPORTES
model Deporte {
  id        String   @id @default(cuid())
  nombre    String
  icono     String?
  
  complejoId String
  complejo   Complejo @relation(fields: [complejoId], references: [id], onDelete: Cascade)
  
  canchas   Cancha[]
  
  @@unique([complejoId, nombre])
}

// CANCHAS
enum EstadoCancha {
  HABILITADA
  DESHABILITADA
  EN_MANTENIMIENTO
}

model Cancha {
  id          String       @id @default(cuid())
  nombre      String
  descripcion String?
  estado      EstadoCancha @default(HABILITADA)
  
  precioBase  Decimal @db.Decimal(10, 2)
  
  complejoId  String
  complejo    Complejo @relation(fields: [complejoId], references: [id], onDelete: Cascade)
  
  deporteId   String
  deporte     Deporte  @relation(fields: [deporteId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  configuracionHorarios ConfiguracionHorarioCancha[]
  preciosDinamicos      PrecioDinamico[]
  turnos                Turno[]
  turnosFijos           TurnoFijo[]
  
  @@unique([complejoId, nombre])
}

// CONFIGURACION DE HORARIOS
model ConfiguracionHorarioCancha {
  id              String   @id @default(cuid())
  diaSemana       Int
  horaInicio      String
  horaFin         String
  duracionTurno   Int
  activo          Boolean  @default(true)
  
  diasAdelante    Int      @default(30)
  ultimaGeneracion DateTime?
  
  canchaId        String
  cancha          Cancha   @relation(fields: [canchaId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([canchaId, diaSemana])
}

// PRECIOS DINAMICOS
model PrecioDinamico {
  id              String   @id @default(cuid())
  diaSemana       Int
  porcentaje      Int
  descripcion     String?
  
  canchaId        String
  cancha          Cancha   @relation(fields: [canchaId], references: [id], onDelete: Cascade)
  
  @@unique([canchaId, diaSemana])
}

// TURNOS
enum EstadoTurno {
  DISPONIBLE
  RESERVADO
  SENA_ENVIADA
  CONFIRMADO
  CANCELADO
  EXPIRADO
  AUSENTE
  BLOQUEADO
}

model Turno {
  id          String      @id @default(cuid())
  fecha       DateTime    @db.Timestamptz  // ✅ CAMBIO
  duracion    Int
  estado      EstadoTurno @default(DISPONIBLE)
  
  dni              String?
  nombreCliente    String?
  apellidoCliente  String?
  telefonoCliente  String?
  
  precioTotal      Decimal  @db.Decimal(10, 2)
  montoSeña        Decimal? @db.Decimal(10, 2)
  
  fechaReserva      DateTime?  @db.Timestamptz  // ✅ CAMBIO
  fechaExpiracion   DateTime?  @db.Timestamptz  // ✅ CAMBIO
  fechaConfirmacion DateTime?  @db.Timestamptz  // ✅ CAMBIO
  
  canchaId    String
  cancha      Cancha   @relation(fields: [canchaId], references: [id])
  
  complejoId  String
  complejo    Complejo @relation(fields: [complejoId], references: [id])
  
  usuarioId   String?
  usuario     Usuario? @relation(fields: [usuarioId], references: [id])
  
  turnoFijoId String?
  turnoFijo   TurnoFijo? @relation(fields: [turnoFijoId], references: [id])
  
  pago        Pago?
  
  createdAt   DateTime @default(now())  @db.Timestamptz  // ✅ CAMBIO
  updatedAt   DateTime @updatedAt       @db.Timestamptz  // ✅ CAMBIO
  
  @@index([fecha, canchaId])
  @@index([estado])
  @@index([dni])
  @@index([telefonoCliente])
}

// PAGOS
enum MetodoPago {
  TRANSFERENCIA
  EFECTIVO
  MERCADOPAGO
  OTRO
}

enum EstadoPago {
  PENDIENTE
  ENVIADO
  APROBADO
  RECHAZADO
}

model Pago {
  id          String      @id @default(cuid())
  monto       Decimal     @db.Decimal(10, 2)
  metodo      MetodoPago  @default(TRANSFERENCIA)
  estado      EstadoPago  @default(PENDIENTE)
  
  fechaEnvio      DateTime?
  fechaValidacion DateTime?
  
  motivoRechazo   String?
  
  turnoId     String   @unique
  turno       Turno    @relation(fields: [turnoId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// TURNOS FIJOS
model TurnoFijo {
  id          String   @id @default(cuid())
  diaSemana   Int
  horaInicio  String
  duracion    Int
  
  activo      Boolean  @default(true)
  fechaInicio DateTime
  fechaFin    DateTime?
  
  requiereSeña Boolean @default(true)  // NUEVO
  
  usuarioId   String
  usuario     Usuario  @relation(fields: [usuarioId], references: [id])
  
  canchaId    String
  cancha      Cancha   @relation(fields: [canchaId], references: [id])
  
  turnosGenerados Turno[]
  historial       HistorialTurnoFijo[]  // NUEVO
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([canchaId, diaSemana, horaInicio])
}

model HistorialTurnoFijo {
  id          String   @id @default(cuid())
  turnoFijoId String
  accion      String   // "CREADO", "PAUSADO", "REACTIVADO", "CANCHA_CAMBIADA", "CANCELADO"
  detalle     String?
  usuarioId   String?  // Quién realizó la acción
  createdAt   DateTime @default(now())
  
  turnoFijo   TurnoFijo @relation(fields: [turnoFijoId], references: [id], onDelete: Cascade)
}

// CONFIGURACION DE TEMA (PERSONALIZACIÓN)
model ConfiguracionTema {
  id              String   @id @default(cuid())
  complejoId      String   @unique
  
  // BRANDING BÁSICO
  logoUrl         String?
  faviconUrl      String?
  nombreMostrar   String
  
  // COLORES (formato HEX)
  colorPrimario   String   @default("#0a0a0a")
  colorSecundario String   @default("#404040")
  colorAccent     String   @default("#22c55e")
  colorFondo      String   @default("#ffffff")
  
  // TEXTOS PERSONALIZABLES
  textoHeroPrincipal   String?  @db.Text
  textoHeroSecundario  String?  @db.Text
  textoFooter          String?  @db.Text
  textoWhatsApp        String?  @db.Text
  
  // BANNERS (URLs a imágenes)
  bannerHomeUrl       String?
  bannerReservaUrl    String?
  
  // SEO
  metaTitle           String?
  metaDescription     String?  @db.Text
  metaKeywords        String?
  
  // REDES SOCIALES
  facebookUrl     String?
  instagramUrl    String?
  tiktokUrl       String?
  
  // CONFIGURACIÓN AVANZADA
  fontFamily      String?  @default("Inter")
  
  complejo        Complejo @relation(fields: [complejoId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([complejoId])
}